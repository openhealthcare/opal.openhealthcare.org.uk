<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>Upgrading - OPAL</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="../../opaldocs.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">
              <img src="/img/opallogo.png" height="30"/>
            </a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">Home</a>
                </li>
            
            
            
                <li >
                    <a href="../../installation/">Installation</a>
                </li>
            
            
            
                <li >
                    <a href="../../tutorial/">Tutorial</a>
                </li>
            
            
            
                <li >
                    <a href="../../guides/topic-guides/">Guides</a>
                </li>
            
            
            
                <li >
                    <a href="../reference_guides/">Reference</a>
                </li>
            
            
            
                <!-- <li class="dropdown"> -->
                <!--     <a href="#" class="dropdown-toggle" data-toggle="dropdown">Topic Guides <b class="caret"></b></a> -->
                <!--     <ul class="dropdown-menu"> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../../guides/components_overview/">Component Overview</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../../guides/command_line_tool/">Command Line tool</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../../guides/plugins/">Plugins</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../../guides/plugins_list/">Plugin List</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../../guides/datamodel/">Data Model</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../../guides/flow/">Flow</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../../guides/roles_and_permissions/">Roles & Permissions</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../../guides/tagging/">Tagging</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../../guides/json_api/">JSON API</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../../guides/lookup_lists/">Lookup Lists</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../../guides/templates/">Templates</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../../guides/context_processors/">Context Processors</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../../guides/static_files/">Static Files</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../../guides/forms/">Forms</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../../guides/patient_detail_views/">Patient Detail Views</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../../guides/list_views/">Patient List Views</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../../guides/discoverable/">Discoverable Features</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../../guides/search/">Search Overview</a> -->
                <!--         </li> -->
                <!--      -->
                <!--     </ul> -->
                <!-- </li> -->
            
            
            
                <!-- <li class="dropdown active"> -->
                <!--     <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a> -->
                <!--     <ul class="dropdown-menu"> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../episode/">The Episode model</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../episode_types/">Episode Types</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../patient/">Patient</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../subrecords/">Subrecords</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../opal_application/">OpalApplication</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../episode_service/">Episode service</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../item_service/">Item service</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../patient_summary_service/">Patient summary service</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../form_templatetags/">Form helpers</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../panels_templatetags/">Panel Template tags</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../javascript_helpers/">Javascript helpers</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../javascript_dependencies/">Javascript dependencies</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../schemas/">Schemas</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../search_queries/">Search Queries</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../detail_views/">Detail Views</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../patient_list/">Patient Lists</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li > -->
                <!--             <a href="../search_js_services/">Search JS Services</a> -->
                <!--         </li> -->
                <!--      -->
                <!--         <li class="active"> -->
                <!--             <a href="./">Upgrading</a> -->
                <!--         </li> -->
                <!--      -->
                <!--     </ul> -->
                <!-- </li> -->
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
              <li>
                <a href="https://github.com/openhealthcare/opal/tree/v0.6.0" target="_blank">
                  <i class="fa fa-github"></i> v0.6.0
                </a>
              </li>
                <!-- <li > -->
                <!--     <a rel="next" href="../search_js_services/"> -->
                <!--         <i class="fa fa-arrow-left"></i> Previous -->
                <!--     </a> -->
                <!-- </li> -->
                <!-- <li class="disabled"> -->
                <!--     <a rel="prev" > -->
                <!--         Next <i class="fa fa-arrow-right"></i> -->
                <!--     </a> -->
                <!-- </li> -->
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
  <h3>Contents</h3>
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#upgrading-your-opal-application">Upgrading Your OPAL Application</a></li>
        
            <li><a href="#5x-6x">5.x -&gt; 6.x</a></li>
        
            <li><a href="#4x-5x">4.X -&gt; 5.x</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h2 id="upgrading-your-opal-application">Upgrading Your OPAL Application</h2>
<p>This document provides instructions for specific steps required to upgrading your OPAL
application to a later version where there are extra steps required.</p>
<h3 id="5x-6x">5.x -&gt; 6.x</h3>
<h4 id="upgrading-opal">Upgrading OPAL</h4>
<p>How you do this depends on how you have configured your application, but updating your
requirements.txt to update the version should work.</p>
<pre><code># requirements.txt
opal==0.6.0
</code></pre>
<p>After re-installing (via for instance <code>pip install -r requirements.txt</code>) you will need to
run the migrations for OPAL 0.6.x</p>
<pre><code>$ python manage.py migrate opal
</code></pre>
<h4 id="changes-to-abstract-models">Changes to abstract models</h4>
<p>If you are inheriting from the abstract models in OPAL e.g. <code>Demographics</code> then you should
run a makemigrations command to update to the 0.6.x data model.</p>
<pre><code>python manage.py makemigrations yourapp
python manage.py migrate yourapp
</code></pre>
<p>You should note that as of OPAL 0.6.x <code>Demographics</code> now splits names into first, surname,
middle name and title. The previous <code>name</code> field will be converted to be <code>first_name</code>.</p>
<p>Strategies for updating your data to use the appropriate fields will vary from application
to application, but one good such strategy is to use a data migration <a href="https://github.com/openhealthcare/acute/blob/master/acute/migrations/0004_auto_20160624_1215.py">such as the one done
here</a>.</p>
<h4 id="update-settings">Update settings</h4>
<p>Many of the default OPAL templates now assume that the <code>'opal.context_processors.models'</code>
Context Processor is available - you should add that to the <code>TEMPLATE_CONTEXT_PROCESSORS</code>
setting in your application's <code>settings.py</code></p>
<p>The default date formats in OPAL have changed - and so you should update your <code>DATE_X</code>
settings to match:</p>
<pre><code class="python">DATE_FORMAT = 'd/m/Y'
DATE_INPUT_FORMATS = ['%d/%m/%Y']
DATETIME_FORMAT = 'd/m/Y H:i:s'
DATETIME_INPUT_FORMATS = ['%d/%m/%Y %H:%M:%S']
</code></pre>

<h4 id="upgrade-plugins">Upgrade plugins</h4>
<p>A number of OPAL plugins have new releases to work with the changes in OPAL 0.6.x</p>
<ul>
<li>opal-referral - Upgrade to 0.1.4</li>
<li>opal-wardround - Upgrade to 0.6.0</li>
<li>opal-observations - Upgrade to 0.1.2</li>
<li>opal-dischargesummary - Upgrade to 0.2.0</li>
<li>opal-dashboard - Upgrade to 0.1.3</li>
</ul>
<p>Meanwhile the <code>opal-taskrunner</code> plugin has now been deprecated, this functionality now
living natively within OPAL core.</p>
<h4 id="update-your-teams-to-be-patientlists">Update your Teams to be PatientLists</h4>
<p>Patient Lists are now driven by subclasses of <code>opal.core.PatientList</code>, so we will need
to convert your Teams to be PatientLists. You may want to re-enable the Team admin while
you do so - this is simple, by updating your application's <code>admin.py</code>:</p>
<pre><code># yourapp/admin.py
...
from opal.admin import TeamAdmin
from opal.models import Team
admin.site.register(Team, TeamAdmin)
</code></pre>
<p>Patient lists are now declarative. For instance, to replicate the following team:</p>
<p><img src="/img/resp.team.png" style="margin: 12px auto; border: 1px solid black;"/></p>
<p>We would convert that to:</p>
<pre><code class="python"># yourapp/patient*lists.py
from opal.core import patient_lists

class RespiratoryList(patient_lists.TaggedPatientList):
    display_name = 'Respiratory'
    tag          = 'respiratory'
    order        = 4
    schema       = [models.Demographics, models.Treatment]
</code></pre>

<p>The schema property will likely be available to you in your application's <code>schema.py</code>
file - which is now obsolete.</p>
<p>See the <a href="../../guides/list_views/">full patient list documentation</a> for further details
of the options available for Patient Lists.</p>
<h4 id="form-and-display-templates">Form and Display templates.</h4>
<p>We may now be missing some form or display templates, as your application may be
relying on templates previously in OPAL. To discover which these are, run</p>
<pre><code>$ opal scaffold --dry-run
</code></pre>
<p>You may either create templates by hand, or have OPAL generate boilerplate templates for you
by running <code>$ opal scaffold</code>.</p>
<p>Modal templates already in your application will likely be referencing invalid paths
to their Angular variables. You should update these to include the record name - for example:</p>
<pre><code class="html">&lt;!-- Was --&gt;
{% input  label=&quot;Drug&quot; model=&quot;editing.drug&quot; lookuplist=&quot;antimicrobial_list&quot; %}
&lt;!-- Becomes --&gt;
{% input  label=&quot;Drug&quot; model=&quot;editing.treatment.drug&quot; lookuplist=&quot;antimicrobial_list&quot; %}
</code></pre>

<h4 id="the-inpatient-episode-category">The Inpatient episode category</h4>
<p>The default Episode Category - Inpatient episodes has updated it's database identifier
from <code>inpatient</code> to <code>Inpatient</code>. To update your episodes run :</p>
<pre><code class="python">&gt;&gt;&gt; from opal.models import Episode
&gt;&gt;&gt; for e in Episode.objects.filter(category='inpatient'):
...   e.category='Inpatient'
...   e.save()
...
</code></pre>

<h3 id="4x-5x">4.X -&gt; 5.x</h3>
<h4 id="migrations">Migrations</h4>
<p>Before upgrading from 4.x to 5.x you should ensure that you have upgraded from South
to Djangomigrations.</p>
<pre><code>$ rm yourapp/migrations/*
$ python manage.py makemigrations yourapp
$ python manage.py migrate yourapp --fake-initial
</code></pre>
<h4 id="opal">OPAL</h4>
<p>Next you will need to upgrade the OPAL version itself.</p>
<p>How you do this depends on how you have configured your application, but updating your
requirements.txt to update the version should work. This will also update FFS and Django
Axes as well as adding Python Dateutil.</p>
<pre><code>-e git://github.com/openhealthcare/opal.git@v0.5.6#egg=opal
</code></pre>
<h4 id="migrations_1">Migrations.</h4>
<p>OPAL has fresh migrations in 0.5.x, which we should run. There are also changes to the
base abstract model classes (to add created/updated timestamps) so you'll need to create
fresh migrations for your own application.</p>
<pre><code>$ python manage.py migrate
$ python manage.py makemigrations yourapp
$ python manage.py migrate yourapp
</code></pre>
<p>At this stage you'll want to commit your new migrations, as well as any changes to your
application's requirements file.</p>
<h4 id="tags">Tags</h4>
<p>As of 0.5.5, old tags in OPAL are stored directly on the Tagging model rather than via
Djano Reversion. We can import those old tags by doing the following.</p>
<pre><code>$ python manage.py shell

&gt;&gt;&gt; from opal.models import Tagging
&gt;&gt;&gt; Tagging.import_from_reversion()
</code></pre>
<h4 id="deployment">Deployment</h4>
<p>The first time you deploy your upgraded application you'll need to run the following
commands to upgrade your database:</p>
<pre><code>$ python manage.py migrate --fake-initial
</code></pre>
<p>You'll also have to repeat the Tagging step once for each deployment.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <img src="/img/opallogo.png" class="pull-left"/>
            <center>
              <br />
              OPAL is an Open Source framework for building clinical applications from
              <a href="http://openhealthcare.org.uk" target="_blank">Open Health Care UK</i></a>.
            </center>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
          <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-35112560-5', 'openhealthcare.org.uk');
  ga('send', 'pageview');
          </script>

    </body>
</html>